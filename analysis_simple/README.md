# analysis_simple

Basic computer vision pipeline for detecting satellites, meteors, and other transient events in astronomical time-lapse images.

## Overview

This project provides tools to analyze sequences of astronomical images (time-lapse frames) to detect and catalog transient events such as:
- Satellite streaks
- Meteor trails
- Aircraft paths
- Other moving objects in the night sky

The analysis pipeline processes JPEG frames, builds a sky mask to exclude non-sky regions, and uses computer vision techniques (edge detection, Hough transforms) to identify linear streaks indicative of transient events.

## Features

- **Configurable Analysis Pipeline**: All detection parameters can be customized via YAML configuration
- **Sky Masking**: Automatically excludes camera housing, overlay text, and dark regions
- **Streak Detection**: Uses Canny edge detection and Hough line transforms
- **Metrics Tracking**: Records brightness, contrast, and streak counts per frame
- **Event Cataloging**: Identifies and logs frames with significant transient activity
- **Visualization Tools**: Plot metrics over time and overlay detected streaks on images
- **Validation Utilities**: Check data structure and image quality before analysis

## Installation

### Prerequisites

- Python 3.7 or higher
- pip package manager

### Install Dependencies

```bash
pip install -r requirements.txt
```

This will install:
- `opencv-python` - Image processing and computer vision
- `numpy` - Numerical operations
- `matplotlib` - Plotting and visualization
- `PyYAML` - Configuration file parsing

## Usage

### Getting Data

If you don't have data yet, use the data_fetch tool to download images:

```bash
cd tools/data_fetch
python fetch.py 20251224
```

This automatically creates `../data/night_2025-12-24/frames/` and downloads all images.

### Running Analysis

#### Basic Analysis

Analyze a night's worth of frames:

```bash
python analysis_simple/analyze.py data/night_2025-12-24/
```

#### Run All Tools (Recommended)

Run validation, analysis, visualization, and overlay generation in one command:

```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --all-tools
```

This will:
1. **Validate** data structure and frames before analysis
2. **Analyze** all frames and detect transient events
3. **Visualize** metrics with time-series plots
4. **Overlay** detected streaks on event frames

#### Individual Tool Options

Run specific tools:

```bash
# Validate before analysis
python analysis_simple/analyze.py data/night_2025-12-24/ --validate

# Generate plots after analysis
python analysis_simple/analyze.py data/night_2025-12-24/ --visualize

# Create annotated frames with detected streaks
python analysis_simple/analyze.py data/night_2025-12-24/ --overlay

# Combine multiple options
python analysis_simple/analyze.py data/night_2025-12-24/ --validate --visualize
```

#### With Custom Configuration

```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --config custom_config.yaml --all-tools
```

#### Get Help

```bash
python analysis_simple/analyze.py --help
```

## Folder Structure

Your data should be organized as follows:

```
night_2025-12-24/
├── frames/
│   ├── frame_001.jpg
│   ├── frame_002.jpg
│   ├── frame_003.jpg
│   └── ...
├── sky_mask.png          (generated on first run)
├── metrics.csv           (generated output)
├── events.json           (generated output)
├── plots/                (generated with --visualize)
│   ├── brightness_over_time.png
│   ├── contrast_over_time.png
│   └── streak_counts.png
└── annotated/            (generated with --overlay)
    ├── frame_002.jpg
    └── ...
```

**Required:**
- `frames/` directory containing `.jpg` image files

**Generated by analysis:**
- `sky_mask.png` - Binary mask excluding non-sky regions
- `metrics.csv` - Per-frame statistics
- `events.json` - Detected transient events

**Generated with --visualize:**
- `plots/` - Directory containing time-series plots

**Generated with --overlay:**
- `annotated/` - Directory containing frames with detected streaks drawn

## Output Files

### metrics.csv

CSV file with one row per frame containing:

| Column | Description |
|--------|-------------|
| `file` | Filename of the frame |
| `mean_brightness` | Average pixel brightness in sky region |
| `star_contrast` | Standard deviation of high-pass filtered image (star visibility metric) |
| `streak_count` | Number of linear streaks detected |

Example:
```csv
file,mean_brightness,star_contrast,streak_count
frame_001.jpg,45.23,12.8,0
frame_002.jpg,44.89,13.1,3
frame_003.jpg,46.12,12.5,1
```

### events.json

JSON file containing detected events (frames with significant streak activity):

```json
[
  {
    "file": "frame_002.jpg",
    "reason": "many_streaks",
    "streaks": [
      [120, 50, 180, 200],
      [250, 80, 280, 220]
    ]
  }
]
```

Each streak is represented as `[x1, y1, x2, y2]` - the start and end coordinates of the detected line.

### sky_mask.png

Grayscale image where:
- White pixels (255) = sky region to analyze
- Black pixels (0) = excluded regions (housing, overlays, dark areas)

## Configuration

The analysis pipeline can be customized using a YAML configuration file. By default, the script looks for `config.yaml` in the `analysis_simple/` directory.

### Configuration Parameters

```yaml
masking:
  brightness_threshold: 10      # Pixels darker than this are excluded
  overlay_region:               # Region to mask out (e.g., camera overlay text)
    top: 0
    bottom: 140
    left: 0
    right: 450

analysis:
  gaussian_sigma: 5             # Sigma for Gaussian blur in star contrast calculation

streak_detection:
  canny_low: 40                 # Lower threshold for Canny edge detection
  canny_high: 120               # Upper threshold for Canny edge detection
  hough_threshold: 60           # Accumulator threshold for Hough line detection
  min_line_length: 40           # Minimum line length in pixels
  max_line_gap: 10              # Maximum gap between line segments to connect

events:
  min_streaks: 2                # Minimum streaks to flag as an event
```

### Creating Custom Configuration

1. Copy the default `config.yaml`:
   ```bash
   cd analysis_simple/
   cp config.yaml my_config.yaml
   ```

2. Edit parameters as needed

3. Run analysis with custom config:
   ```bash
   python analyze.py ../path/to/night_data --config my_config.yaml
   ```

## Visualization

The visualization and overlay tools are now integrated into `analyze.py` via command-line flags. However, they can still be run independently if needed.

### Plot Metrics Over Time

Visualize brightness, contrast, and streak counts:

**Integrated method (recommended):**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --visualize
```

**Standalone method:**
```bash
python analysis_simple/tools/visualize.py data/night_2025-12-24/
```

Generates plots in `data/night_2025-12-24/plots/`:
- `brightness_over_time.png`
- `contrast_over_time.png`
- `streak_counts.png`

Optional flags:
- `--show` - Display plots interactively
- `--output <dir>` - Specify custom output directory

### Overlay Detected Streaks

Draw detected streaks on the original images:

**Integrated method (recommended):**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --overlay
```

**Standalone method:**
```bash
python analysis_simple/tools/overlay_streaks.py data/night_2025-12-24/
```

Creates annotated images in `data/night_2025-12-24/annotated/` with detected streaks drawn in red.

Optional flags:
- `--output <dir>` - Specify custom output directory

## Validation

Before running analysis, validate your data structure:

**Integrated method (recommended):**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --validate
```

**Standalone method:**
```bash
python analysis_simple/tools/validate_data.py data/night_2025-12-24/
```

This checks:
- Directory structure is correct
- Frames directory exists and contains images
- Image format and dimensions are consistent
- Configuration file validity
- Warns about potential issues

## Example Data

See `../data/night_2025-12-24/` for a sample data structure with example outputs.

## Troubleshooting

### "No frames found"
- Ensure your images are in `.jpg` format (not `.jpeg`, `.png`, etc.)
- Check that images are in the `frames/` subdirectory
- Run validation: `python analysis_simple/analyze.py <night_dir> --validate`

### "Config file not found"
- The script looks for `config.yaml` in the current directory by default
- Specify a custom path with `--config` flag
- The script will use defaults if no config is found

### Poor detection results
- Adjust `streak_detection` parameters in `config.yaml`
- Lower `hough_threshold` for more sensitive detection
- Increase `min_line_length` to filter out noise
- Check `sky_mask.png` to ensure the mask covers the right region
- Use `--overlay` to visualize what's being detected

### "IndexError: boolean index did not match"
- This means some frames have different dimensions than others
- The script now automatically skips frames with mismatched dimensions
- Check warnings in the output for which frames were skipped
- Run validation to identify problematic frames: `--validate`

### Memory issues with large datasets
- Process nights in smaller batches
- Reduce image resolution before analysis
- Monitor progress output to identify problematic frames

### Tool scripts not running
- Ensure you're running from the project root directory
- Check that tool scripts exist in `analysis_simple/tools/`
- Run tools individually to see detailed error messages

## Contributing

Contributions are welcome! This is an experimental project for exploring ML techniques in astronomical image analysis.

## License

See repository for license information.
